# LUỒNG GIAO TIẾP HỆ THỐNG

## 1. Luồng Đăng ký / Đăng nhập

### 1.1 Customer Registration Flow

```
┌──────────┐      ┌───────────────┐      ┌──────────────┐      ┌─────────┐
│  User    │      │   Frontend    │      │   Backend    │      │   DB    │
└────┬─────┘      └───────┬───────┘      └──────┬───────┘      └────┬────┘
     │                    │                     │                    │
     │  1. Fill Form      │                     │                    │
     ├───────────────────►│                     │                    │
     │                    │                     │                    │
     │                    │ 2. POST /customer/  │                    │
     │                    │    register         │                    │
     │                    ├────────────────────►│                    │
     │                    │                     │                    │
     │                    │                     │ 3. Validate data   │
     │                    │                     ├───────────────────►│
     │                    │                     │                    │
     │                    │                     │ 4. Hash password   │
     │                    │                     │    Insert customer │
     │                    │                     ├───────────────────►│
     │                    │                     │                    │
     │                    │                     │ 5. Generate JWT    │
     │                    │ 6. Return token     │◄───────────────────┤
     │                    │◄────────────────────┤                    │
     │                    │                     │                    │
     │                    │ 7. Store token      │                    │
     │                    │    in localStorage  │                    │
     │                    │                     │                    │
     │  8. Redirect to    │                     │                    │
     │     Home           │                     │                    │
     │◄───────────────────┤                     │                    │
     │                    │                     │                    │
```

### 1.2 Customer Login Flow

```
┌──────────┐      ┌───────────────┐      ┌──────────────┐      ┌─────────┐
│  User    │      │   Frontend    │      │   Backend    │      │   DB    │
└────┬─────┘      └───────┬───────┘      └──────┬───────┘      └────┬────┘
     │                    │                     │                    │
     │  1. Enter email    │                     │                    │
     │     password       │                     │                    │
     ├───────────────────►│                     │                    │
     │                    │                     │                    │
     │                    │ 2. POST /customer/  │                    │
     │                    │    login            │                    │
     │                    ├────────────────────►│                    │
     │                    │                     │                    │
     │                    │                     │ 3. Find customer   │
     │                    │                     │    by email        │
     │                    │                     ├───────────────────►│
     │                    │                     │◄───────────────────┤
     │                    │                     │                    │
     │                    │                     │ 4. Verify password │
     │                    │                     │    (bcrypt)        │
     │                    │                     │                    │
     │                    │                     │ 5. Generate JWT    │
     │                    │ 6. Return token +   │                    │
     │                    │    user info        │                    │
     │                    │◄────────────────────┤                    │
     │                    │                     │                    │
     │  7. Show user      │                     │                    │
     │     Fetch cart     │                     │                    │
     │◄───────────────────┤                     │                    │
```

---

## 2. Luồng Xem Sản phẩm

### 2.1 Browse Products Flow

```
┌──────────┐      ┌───────────────┐      ┌──────────────┐      ┌─────────┐
│  User    │      │   Frontend    │      │   Backend    │      │   DB    │
└────┬─────┘      └───────┬───────┘      └──────┬───────┘      └────┬────┘
     │                    │                     │                    │
     │  1. Click "Sản     │                     │                    │
     │     phẩm"          │                     │                    │
     ├───────────────────►│                     │                    │
     │                    │                     │                    │
     │                    │ 2. GET /public/     │                    │
     │                    │    products?...     │                    │
     │                    ├────────────────────►│                    │
     │                    │                     │                    │
     │                    │                     │ 3. Query products  │
     │                    │                     │    with filters    │
     │                    │                     ├───────────────────►│
     │                    │                     │◄───────────────────┤
     │                    │                     │                    │
     │                    │ 4. Return paginated │                    │
     │                    │    product list     │                    │
     │                    │◄────────────────────┤                    │
     │                    │                     │                    │
     │  5. Render         │                     │                    │
     │     product grid   │                     │                    │
     │◄───────────────────┤                     │                    │
```

### 2.2 View Product Detail Flow

```
┌──────────┐      ┌───────────────┐      ┌──────────────┐      ┌─────────┐
│  User    │      │   Frontend    │      │   Backend    │      │   DB    │
└────┬─────┘      └───────┬───────┘      └──────┬───────┘      └────┬────┘
     │                    │                     │                    │
     │  1. Click product  │                     │                    │
     ├───────────────────►│                     │                    │
     │                    │                     │                    │
     │                    │ 2. GET /public/     │                    │
     │                    │    products/{slug}  │                    │
     │                    ├────────────────────►│                    │
     │                    │                     │                    │
     │                    │                     │ 3. Get product +   │
     │                    │                     │    images + reviews│
     │                    │                     │    Increment view  │
     │                    │                     ├───────────────────►│
     │                    │                     │◄───────────────────┤
     │                    │                     │                    │
     │                    │ 4. Return product   │                    │
     │                    │    detail           │                    │
     │                    │◄────────────────────┤                    │
     │                    │                     │                    │
     │  5. Render detail  │                     │                    │
     │     page           │                     │                    │
     │◄───────────────────┤                     │                    │
```

---

## 3. Luồng Giỏ hàng

### 3.1 Add to Cart Flow

```
┌──────────┐      ┌───────────────┐      ┌──────────────┐      ┌─────────┐
│  User    │      │   Frontend    │      │   Backend    │      │   DB    │
└────┬─────┘      └───────┬───────┘      └──────┬───────┘      └────┬────┘
     │                    │                     │                    │
     │  1. Click "Thêm    │                     │                    │
     │     vào giỏ"       │                     │                    │
     ├───────────────────►│                     │                    │
     │                    │                     │                    │
     │                    │ 2. POST /cart       │                    │
     │                    │    {product_id,     │                    │
     │                    │     quantity}       │                    │
     │                    │    [+ JWT Token]    │                    │
     │                    ├────────────────────►│                    │
     │                    │                     │                    │
     │                    │                     │ 3. Verify token    │
     │                    │                     │ 4. Check stock     │
     │                    │                     │ 5. Get/Create cart │
     │                    │                     │ 6. Add cart_item   │
     │                    │                     ├───────────────────►│
     │                    │                     │◄───────────────────┤
     │                    │                     │                    │
     │                    │ 7. Return updated   │                    │
     │                    │    cart             │                    │
     │                    │◄────────────────────┤                    │
     │                    │                     │                    │
     │  8. Update cart    │                     │                    │
     │     badge/counter  │                     │                    │
     │◄───────────────────┤                     │                    │
```

---

## 4. Luồng Đặt hàng & Thanh toán

### 4.1 Checkout Flow (COD)

```
┌──────────┐      ┌───────────────┐      ┌──────────────┐      ┌─────────┐
│  User    │      │   Frontend    │      │   Backend    │      │   DB    │
└────┬─────┘      └───────┬───────┘      └──────┬───────┘      └────┬────┘
     │                    │                     │                    │
     │  1. Nhập thông tin │                     │                    │
     │     giao hàng      │                     │                    │
     │     Chọn COD       │                     │                    │
     ├───────────────────►│                     │                    │
     │                    │                     │                    │
     │                    │ 2. POST /orders     │                    │
     │                    │    {shipping_info,  │                    │
     │                    │     payment: cod}   │                    │
     │                    ├────────────────────►│                    │
     │                    │                     │                    │
     │                    │                     │ 3. Get cart items  │
     │                    │                     │ 4. Validate stock  │
     │                    │                     │ 5. Calculate total │
     │                    │                     │ 6. Generate order  │
     │                    │                     │    code            │
     │                    │                     │ 7. Create order +  │
     │                    │                     │    order_items     │
     │                    │                     │ 8. Reduce stock    │
     │                    │                     │ 9. Clear cart      │
     │                    │                     ├───────────────────►│
     │                    │                     │◄───────────────────┤
     │                    │                     │                    │
     │                    │ 10. Return order    │                    │
     │                    │     info            │                    │
     │                    │◄────────────────────┤                    │
     │                    │                     │                    │
     │  11. Redirect to   │                     │                    │
     │      order success │                     │                    │
     │◄───────────────────┤                     │                    │
```

### 4.2 Checkout Flow (Online Payment - SePay)

```
┌──────────┐   ┌───────────┐   ┌─────────────┐   ┌───────┐   ┌───────┐
│  User    │   │  Frontend │   │   Backend   │   │   DB  │   │ SePay │
└────┬─────┘   └─────┬─────┘   └──────┬──────┘   └───┬───┘   └───┬───┘
     │               │                │              │           │
     │ 1. Chọn "Thanh│                │              │           │
     │    toán online│                │              │           │
     ├──────────────►│                │              │           │
     │               │                │              │           │
     │               │ 2. POST /orders│              │           │
     │               ├───────────────►│              │           │
     │               │                │              │           │
     │               │                │ 3. Create    │           │
     │               │                │    order     │           │
     │               │                ├─────────────►│           │
     │               │                │              │           │
     │               │ 4. Order created              │           │
     │               │◄───────────────┤              │           │
     │               │                │              │           │
     │               │ 5. POST /payment/create       │           │
     │               ├───────────────►│              │           │
     │               │                │              │           │
     │               │                │ 6. Create    │           │
     │               │                │    payment   │           │
     │               │                │    transaction│          │
     │               │                ├─────────────►│           │
     │               │                │              │           │
     │               │                │ 7. Generate  │           │
     │               │                │    VietQR URL│           │
     │               │                ├──────────────────────────►│
     │               │                │              │           │
     │               │ 8. Return QR   │              │           │
     │               │    code URL +  │              │           │
     │               │    bank info   │              │           │
     │               │◄───────────────┤              │           │
     │               │                │              │           │
     │ 9. Hiển thị   │                │              │           │
     │    QR code    │                │              │           │
     │◄──────────────┤                │              │           │
     │               │                │              │           │
     │ 10. User quét │                │              │           │
     │     QR & CK   ├─────────────────────────────────────────►│
     │               │                │              │           │
     │               │                │ 11. Webhook  │           │
     │               │                │◄──────────────────────────┤
     │               │                │              │           │
     │               │                │ 12. Verify   │           │
     │               │                │     Update   │           │
     │               │                │     order    │           │
     │               │                ├─────────────►│           │
     │               │                │              │           │
     │               │ 13. Poll status│              │           │
     │               ├───────────────►│              │           │
     │               │◄───────────────┤              │           │
     │               │                │              │           │
     │ 14. Thanh toán│                │              │           │
     │     thành công│                │              │           │
     │◄──────────────┤                │              │           │
```

---

## 5. Luồng AI Chatbot

### 5.1 Chat with AI Flow

```
┌──────────┐   ┌───────────┐   ┌─────────────┐   ┌───────┐   ┌────────┐
│  User    │   │  Frontend │   │   Backend   │   │   DB  │   │ Gemini │
└────┬─────┘   └─────┬─────┘   └──────┬──────┘   └───┬───┘   └───┬────┘
     │               │                │              │           │
     │ 1. Nhập tin   │                │              │           │
     │    nhắn       │                │              │           │
     ├──────────────►│                │              │           │
     │               │                │              │           │
     │               │ 2. POST /chat/ │              │           │
     │               │    message     │              │           │
     │               ├───────────────►│              │           │
     │               │                │              │           │
     │               │                │ 3. Get/Create│           │
     │               │                │    conversation          │
     │               │                ├─────────────►│           │
     │               │                │              │           │
     │               │                │ 4. Save user │           │
     │               │                │    message   │           │
     │               │                ├─────────────►│           │
     │               │                │              │           │
     │               │                │ 5. Get context           │
     │               │                │    (recent msgs,         │
     │               │                │     product info)        │
     │               │                ├─────────────►│           │
     │               │                │              │           │
     │               │                │ 6. Call      │           │
     │               │                │    Gemini API│           │
     │               │                ├──────────────────────────►│
     │               │                │              │◄───────────┤
     │               │                │              │           │
     │               │                │ 7. Save bot  │           │
     │               │                │    message   │           │
     │               │                ├─────────────►│           │
     │               │                │              │           │
     │               │ 8. Return bot  │              │           │
     │               │    response    │              │           │
     │               │◄───────────────┤              │           │
     │               │                │              │           │
     │ 9. Hiển thị   │                │              │           │
     │    response   │                │              │           │
     │◄──────────────┤                │              │           │
```

---

## 6. Luồng Admin

### 6.1 Admin Dashboard Flow

```
┌──────────┐      ┌───────────────┐      ┌──────────────┐      ┌─────────┐
│  Admin   │      │   Frontend    │      │   Backend    │      │   DB    │
└────┬─────┘      └───────┬───────┘      └──────┬───────┘      └────┬────┘
     │                    │                     │                    │
     │  1. Access /admin  │                     │                    │
     ├───────────────────►│                     │                    │
     │                    │                     │                    │
     │                    │ 2. Check admin      │                    │
     │                    │    token in         │                    │
     │                    │    localStorage     │                    │
     │                    │                     │                    │
     │                    │ 3. GET /admin/stats/│                    │
     │                    │    overview         │                    │
     │                    │ 4. GET /admin/stats/│                    │
     │                    │    revenue-chart    │                    │
     │                    │ 5. GET /admin/stats/│                    │
     │                    │    recent-orders    │                    │
     │                    ├────────────────────►│                    │
     │                    │                     │                    │
     │                    │                     │ 6. Aggregate stats │
     │                    │                     ├───────────────────►│
     │                    │                     │◄───────────────────┤
     │                    │                     │                    │
     │                    │ 7. Return stats     │                    │
     │                    │◄────────────────────┤                    │
     │                    │                     │                    │
     │  8. Render         │                     │                    │
     │     dashboard      │                    │                    │
     │◄───────────────────┤                     │                    │
```

### 6.2 Admin Manage Products Flow

```
┌──────────┐   ┌───────────┐   ┌─────────────┐   ┌───────┐   ┌──────────┐
│  Admin   │   │  Frontend │   │   Backend   │   │   DB  │   │Cloudinary│
└────┬─────┘   └─────┬─────┘   └──────┬──────┘   └───┬───┘   └────┬─────┘
     │               │                │              │            │
     │ 1. Thêm sản   │                │              │            │
     │    phẩm mới   │                │              │            │
     ├──────────────►│                │              │            │
     │               │                │              │            │
     │               │ 2. Upload ảnh  │              │            │
     │               │    trực tiếp   │              │            │
     │               │    lên Cloudinary             │            │
     │               ├────────────────────────────────────────────►│
     │               │◄────────────────────────────────────────────┤
     │               │                │              │            │
     │               │ 3. POST /admin/│              │            │
     │               │    products    │              │            │
     │               │    {data +     │              │            │
     │               │     image URLs}│              │            │
     │               ├───────────────►│              │            │
     │               │                │              │            │
     │               │                │ 4. Validate  │            │
     │               │                │ 5. Create    │            │
     │               │                │    product + │            │
     │               │                │    images    │            │
     │               │                ├─────────────►│            │
     │               │                │              │            │
     │               │ 6. Success     │              │            │
     │               │◄───────────────┤              │            │
     │               │                │              │            │
     │ 7. Redirect   │                │              │            │
     │    to list    │                │              │            │
     │◄──────────────┤                │              │            │
```
